name: Build nezha-agent binary

on:
  workflow_run:
    workflows: ["Run Tests"]
    branches: [main]
    types:
      - completed
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number'
        required: true

env:
  RELEASE_VERSION: ${{ github.event.inputs.version }}

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          repository: 'nezhahq/agent'
          fetch-depth: '1'

      - uses: actions/setup-go@v4
        with:
          go-version: 'stable'

      - name: Build
        timeout-minutes: 180
        run: |
          VERSION="${RELEASE_VERSION}"
          DATE=$(date -u '+%Y-%m-%d-%H%M UTC')
          VERSION_FLAGS="-X 'main.Version=${VERSION}' -X 'main.BuildTime=${DATE}'"
          NAME="nezha-agent"
          SRC="./cmd/agent"
          mkdir -p release
          for ARCH in amd64 arm64; do
            CGO_ENABLED=0 GOOS=linux GOARCH=$ARCH go build -mod=mod -ldflags="${VERSION_FLAGS} -w -s" -o release/${NAME}-linux-${ARCH} ${SRC}
          done

      - name: Compress with UPX
        run: |
          wget $(wget -qO- https://api.github.com/repos/upx/upx/releases/latest | grep -oP 'https://github.com/upx/upx/releases/download/.*amd64_linux\.tar\.xz')
          tar -xf upx*.tar.xz
          sudo mv upx*/upx /usr/local/bin
          upx -9 release/*

      - name: Upload artifacts
        uses: actions/upload-artifact@v3
        with:
          name: nezha-agent
          path: release

      - name: Create release
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.ACCESS_KEY }}
        with:
          tag_name: ${{ github.run_number }}
          files: release/*

      - name: Clean up old releases and runs
        env:
          GITHUB_TOKEN: ${{ secrets.ACCESS_KEY }}
        run: |
          # Get the latest two release tags
          LATEST_TAGS=$(gh release list --repo mjjonone/nezha-agent-binary --limit 2 | awk '{print \$1}')
          
          # Delete old releases except the latest two
          gh release list --repo mjjonone/nezha-agent-binary --limit 100 | awk 'NR>2 {print \$1}' | while read -r release; do
            if ! echo "$LATEST_TAGS" | grep -q "$release"; then
              gh release delete --repo mjjonone/nezha-agent-binary "$release" --yes
            fi
          done
          
          # Delete old tags except the latest two
          gh api repos/mjjonone/nezha-agent-binary/git/refs/tags --jq '.[].ref' | sed 's/refs\/tags\///' | while read -r tag; do
            if ! echo "$LATEST_TAGS" | grep -q "$tag"; then
              gh api --method DELETE /repos/mjjonone/nezha-agent-binary/git/refs/tags/"$tag"
            fi
          done
          
          # Delete old workflow runs, keeping the latest two
          gh api -X GET /repos/mjjonone/nezha-agent-binary/actions/runs | jq -r '.workflow_runs | sort_by(.run_number) | reverse | .[2:] | .[].id' | while read -r run_id; do
            gh api -X DELETE /repos/mjjonone/nezha-agent-binary/actions/runs/"$run_id"
          done
        shell: /usr/bin/bash --noprofile --norc -e -o pipefail {0}
